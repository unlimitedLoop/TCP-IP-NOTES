<!-- MarkdownTOC -->

- [网络层](#网络层)
    - [IP首部](#ip首部)
    - [ICMP重定向差错](#icmp重定向差错)
    - [ICMP路由发现报文](#icmp路由发现报文)

<!-- /MarkdownTOC -->


# 网络层
IP是TCP/IP协议族中最为核心的协议

IP协议提供不可靠、无连接的数据报传送
+ 不可靠指的是它不能保证IP数据报能成功到达目的地
+ 无连接指的是IP不维护任何关于后续数据报的状态信息

## IP首部
不含有选项的IP首部有20个字节
![IP首部](/images/IP-data.PNG "IP首部")

总长度字段为整个IP数据报长度，已字节为单位，总字段长度为16位，所以IP数据报最大可为65535字节

TTL生存时间字段设置了数据报可以经过的最多路由器数目，每经过一个路由器，这个值就减一，当该字段为0时，这个数据报会被抛弃，并发送ICMP报文通知源主机

路由表包含信息
+ 目的IP地址
+ 下一站路由IP地址
+ 标志
+ 数据报传输指定接口

IP路由选择是逐跳的，IP不知道目的地的直接路径，通过路由器通过路由表进行转发，到达目的IP

IP路由选择主要是以下功能：
+ 搜索路由表，寻找与目的IP完全匹配的表项，如果找到则直接转发到目的IP地址
+ 搜索路由表，寻找与目的地网络号匹配的表项，如果找到则发送给该表项指定的下一站路由
+ 搜索路由表，寻找默认表项，如果找到则发送到该表项指定的下一站路由
+ 如果上述三个步骤都失败，则生成数据报表示主机不可达错误

为一个网络指定路由器，而不是为每个主机指定一个路由器，这样可以极大的缩小路由表规模

IP路由选择通过路由之间转发实现，每次转发目的IP地址都不会改变，但是封装和目的链路层地址在每一站都可以改变

## ICMP重定向差错
当IP数据报被发送到一个路由器时，收到数据报的路由器就要发送ICMP重定向差错报文给IP数据报的发送端
例子
1. 主机的默认路由是R1，主机发送IP数据报时没有找到直接IP和网络号匹配的表项，都会发送给默认路由
2. R1收到数据报后发送给R2，R1监测到R2在同一个LAN
3. R1发送一份ICMP重定向报文给主机，主机更新路由表，以后发送同一个地址的时候把数据报发送给R2而不是R1

## ICMP路由发现报文
主机启动以后会广播或多播传送一份路由器请求报文，一台或更多路由器响应一份路由器通告报文，另外，路由器定期广播或多播传送他们的路由器通告报文，允许每个监听的路由器和主机更新路由表

